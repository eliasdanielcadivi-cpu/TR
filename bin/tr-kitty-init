#!/bin/bash
# tr-kitty-init - Inicializador de Kitty con configuraci√≥n TRON
# ==================================================================
# Este script inicializa kitty usando la configuraci√≥n centralizada
# del proyecto TRON. Se puede ejecutar desde cualquier lugar del sistema.
#
# USO:
#   tr-kitty-init              # Inicia kitty con config TRON
#   tr-kitty-init --new        # Fuerza nueva instancia
#   tr-kitty-init --reload     # Recarga configuraci√≥n en instancia existente
#   tr-kitty-init --status     # Verifica estado de configuraci√≥n
#   tr-kitty-init --link       # Crea enlace simb√≥lico en ~/.config/kitty/
#   tr-kitty-init --unlink     # Elimina enlace simb√≥lico
#   tr-kitty-init --help       # Muestra ayuda

set -e

# Ruta base de TRON
TR_BASE="/home/daniel/tron/programas/TR"
TR_KITTY_CONF="$TR_BASE/config/kitty.conf"
KITTY_USER_CONFIG="$HOME/.config/kitty/kitty.conf"
KITTY_LINK="$HOME/.config/kitty/kitty.conf"
SOCKET_PATH="/tmp/mykitty"

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Funci√≥n para mostrar ayuda
show_help() {
    cat << 'EOF'
tr-kitty-init - Inicializador Kitty con configuraci√≥n TRON
============================================================

USO:
    tr-kitty-init [OPCIONES]

OPCIONES:
    (ninguna)       Inicia kitty con la configuraci√≥n TRON
    --new           Fuerza nueva instancia de kitty
    --reload        Recarga configuraci√≥n en kitty existente
    --status        Verifica estado de configuraci√≥n e instancia
    --link          Crea enlace simb√≥lico en ~/.config/kitty/
    --unlink        Elimina enlace simb√≥lico
    --help, -h      Muestra esta ayuda

DESCRIPCI√ìN:
    Este script permite ejecutar kitty con la configuraci√≥n centralizada
    del proyecto TRON, sin importar desde d√≥nde se ejecute en el sistema.

    La configuraci√≥n incluye:
    - Colores Hacker Neon (fuchsia/cyan de alto contraste)
    - Fuente JetBrainsMono Nerd Font 16pt
    - Atajos de teclado estilo programador
    - Control remoto habilitado para m√≥dulos TR

EJEMPLOS:
    tr-kitty-init
        Inicia kitty con configuraci√≥n TRON

    tr-kitty-init --new
        Fuerza una nueva instancia incluso si ya hay una corriendo

    tr-kitty-init --reload
        Recarga la configuraci√≥n en la instancia actual

    tr-kitty-init --link
        Crea enlace simb√≥lico para que kitty use siempre la config TRON

CONFIGURACI√ìN:
    Archivo principal: /home/daniel/tron/programas/TR/config/kitty.conf
    Enlace usuario:   ~/.config/kitty/kitty.conf
    Socket:           /tmp/mykitty

VERSI√ìN: 1.0.0
EOF
}

# Funci√≥n para verificar si kitty est√° corriendo
is_kitty_running() {
    [ -S "$SOCKET_PATH" ] && kitty @ --to unix:$SOCKET_PATH ls >/dev/null 2>&1
}

# Funci√≥n para verificar configuraci√≥n
check_config() {
    if [ ! -f "$TR_KITTY_CONF" ]; then
        echo -e "${RED}‚úó Error: Configuraci√≥n TRON no encontrada en:$NC"
        echo -e "${RED}  $TR_KITTY_CONF$NC"
        return 1
    fi
    return 0
}

# Funci√≥n para verificar enlace simb√≥lico
check_link() {
    if [ -L "$KITTY_LINK" ]; then
        local target=$(readlink "$KITTY_LINK")
        if [ "$target" = "$TR_KITTY_CONF" ]; then
            return 0
        fi
    fi
    return 1
}

# Funci√≥n para crear enlace simb√≥lico
create_link() {
    echo -e "${CYAN}üìÅ Creando enlace simb√≥lico...$NC"
    
    # Crear directorio si no existe
    mkdir -p "$HOME/.config/kitty"
    
    # Eliminar enlace o archivo existente
    if [ -L "$KITTY_LINK" ] || [ -f "$KITTY_LINK" ]; then
        rm -f "$KITTY_LINK"
        echo -e "${YELLOW}‚ö† Configuraci√≥n anterior eliminada$NC"
    fi
    
    # Crear enlace simb√≥lico
    ln -s "$TR_KITTY_CONF" "$KITTY_LINK"
    
    if [ -L "$KITTY_LINK" ]; then
        echo -e "${GREEN}‚úì Enlace creado exitosamente$NC"
        echo -e "${CYAN}  ~/.config/kitty/kitty.conf ‚Üí $TR_KITTY_CONF$NC"
        echo ""
        echo -e "${MAGENTA}‚Ñπ Kitty usar√° ahora la configuraci√≥n TRON por defecto$NC"
        return 0
    else
        echo -e "${RED}‚úó Error al crear enlace$NC"
        return 1
    fi
}

# Funci√≥n para eliminar enlace simb√≥lico
remove_link() {
    echo -e "${CYAN}üìÅ Eliminando enlace simb√≥lico...$NC"
    
    if [ -L "$KITTY_LINK" ]; then
        rm -f "$KITTY_LINK"
        echo -e "${GREEN}‚úì Enlace eliminado$NC"
        echo -e "${YELLOW}‚Ñπ Kitty volver√° a su configuraci√≥n por defecto$NC"
        return 0
    else
        echo -e "${YELLOW}‚ö† No existe enlace simb√≥lico$NC"
        return 0
    fi
}

# Funci√≥n para mostrar estado
show_status() {
    echo -e "${MAGENTA}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó$NC"
    echo -e "${MAGENTA}‚ïë   TRON KITTY - Estado de Configuraci√≥n                ‚ïë$NC"
    echo -e "${MAGENTA}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù$NC"
    echo ""
    
    # Estado de configuraci√≥n TRON
    if [ -f "$TR_KITTY_CONF" ]; then
        echo -e "${GREEN}‚úì Configuraci√≥n TRON:$NC"
        echo -e "  $TR_KITTY_CONF"
    else
        echo -e "${RED}‚úó Configuraci√≥n TRON:$NC"
        echo -e "  $TR_KITTY_CONF (NO ENCONTRADA)"
    fi
    echo ""
    
    # Estado de enlace simb√≥lico
    if check_link; then
        echo -e "${GREEN}‚úì Enlace simb√≥lico:$NC"
        echo -e "  ~/.config/kitty/kitty.conf ‚Üí $TR_KITTY_CONF"
    elif [ -L "$KITTY_LINK" ]; then
        local target=$(readlink "$KITTY_LINK")
        echo -e "${YELLOW}‚ö† Enlace simb√≥lico (apunta a otro lado):$NC"
        echo -e "  ~/.config/kitty/kitty.conf ‚Üí $target"
    elif [ -f "$KITTY_LINK" ]; then
        echo -e "${YELLOW}‚ö† Archivo kitty.conf existe (no es enlace):$NC"
        echo -e "  $KITTY_LINK"
    else
        echo -e "${YELLOW}‚ö† Enlace simb√≥lico:$NC"
        echo -e "  ~/.config/kitty/kitty.conf (NO EXISTE)"
    fi
    echo ""
    
    # Estado de kitty
    if is_kitty_running; then
        echo -e "${GREEN}‚úì Kitty (con socket TRON):$NC"
        echo -e "  Activo en $SOCKET_PATH"
        
        # Contar pesta√±as
        local tabs=$(kitty @ --to unix:$SOCKET_PATH ls 2>/dev/null | \
            python3 -c "import sys,json; d=json.load(sys.stdin); print(sum(len(w['tabs']) for w in d))" 2>/dev/null || echo "?")
        echo -e "  Pesta√±as abiertas: $tabs"
    else
        echo -e "${YELLOW}‚ö† Kitty (con socket TRON):$NC"
        echo -e "  No est√° corriendo con remote control"
    fi
    echo ""
}

# Funci√≥n para recargar configuraci√≥n
reload_config() {
    if is_kitty_running; then
        echo -e "${CYAN}üîÑ Recargando configuraci√≥n...$NC"
        kitty @ --to unix:$SOCKET_PATH load-config "$TR_KITTY_CONF"
        if [ $? -eq 0 ]; then
            echo -e "${GREEN}‚úì Configuraci√≥n recargada exitosamente$NC"
        else
            echo -e "${RED}‚úó Error al recargar configuraci√≥n$NC"
            return 1
        fi
    else
        echo -e "${YELLOW}‚ö† Kitty no est√° corriendo con socket TRON$NC"
        echo -e "  Inicia kitty con: tr-kitty-init"
        return 1
    fi
}

# Funci√≥n para iniciar kitty
launch_kitty() {
    local force_new=$1
    
    # Verificar configuraci√≥n
    if ! check_config; then
        return 1
    fi
    
    # Verificar si ya est√° corriendo
    if is_kitty_running && [ "$force_new" != "true" ]; then
        echo -e "${YELLOW}‚ö† Kitty ya est√° corriendo con socket TRON$NC"
        echo -e "  Usa --new para forzar nueva instancia"
        echo -e "  Usa --reload para recargar configuraci√≥n"
        return 0
    fi
    
    echo -e "${CYAN}üöÄ Iniciando Kitty con configuraci√≥n TRON...$NC"
    echo -e "  Configuraci√≥n: $TR_KITTY_CONF"
    echo -e "  Socket: $SOCKET_PATH"
    echo ""
    
    # Eliminar socket existente si existe
    [ -S "$SOCKET_PATH" ] && rm -f "$SOCKET_PATH"
    
    # Iniciar kitty
    kitty \
        -c "$TR_KITTY_CONF" \
        --listen-on "$SOCKET_PATH" \
        --detach
    
    # Verificar que inici√≥ correctamente
    sleep 1
    if is_kitty_running; then
        echo -e "${GREEN}‚úì Kitty iniciado exitosamente$NC"
        echo -e "${MAGENTA}  Socket disponible en: $SOCKET_PATH$NC"
        echo ""
        echo -e "${CYAN}‚Ñπ Usa 'tr' para acceder a la ayuda inteligente$NC"
        echo -e "${CYAN}‚Ñπ Usa 'tr-color <ruta>' para colorear pesta√±as$NC"
        return 0
    else
        echo -e "${RED}‚úó Error al iniciar Kitty$NC"
        echo -e "  Verifica que kitty est√© instalado correctamente"
        return 1
    fi
}

# Parsear argumentos
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --status)
        show_status
        ;;
    --link)
        create_link
        ;;
    --unlink)
        remove_link
        ;;
    --reload)
        reload_config
        ;;
    --new)
        launch_kitty "true"
        ;;
    "")
        launch_kitty "false"
        ;;
    *)
        echo -e "${RED}‚úó Opci√≥n no v√°lida: $1$NC"
        echo ""
        show_help
        exit 1
        ;;
esac
