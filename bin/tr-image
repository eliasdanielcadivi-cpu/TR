#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# tr-image - Visor de imÃ¡genes para kitty terminal
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# VisualizaciÃ³n de imÃ¡genes en kitty usando el protocolo de grÃ¡ficos kitty (icat).
# Solo funciona en kitty terminal (usa el protocolo de grÃ¡ficos kitty).
#
# USO:
#   tr image /ruta/a/imagen.jpg
#   tr image --grid imagen1.jpg imagen2.jpg imagen3.jpg
#   tr image --width 80 imagen.png
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# ConfiguraciÃ³n
TR_BASE="/home/daniel/tron/programas/TR"

# FunciÃ³n para mostrar ayuda
show_help() {
    cat << 'EOF'
tr-image - Visor de imÃ¡genes para kitty terminal
=================================================

USO:
    tr image [OPCIONES] <archivo_de_imagen> [archivos_adicionales...]

OPCIONES:
    --grid, -g          Mostrar imÃ¡genes en cuadrÃ­cula (mÃºltiples archivos)
    --width, -w <cols>  Ancho en columnas de terminal (default: auto)
    --height, -h <rows> Alto en filas de terminal (default: auto)
    --align <pos>       AlineaciÃ³n: left, center, right (default: left)
    --scale-up          Escalar imÃ¡genes pequeÃ±as para llenar espacio
    --clear             Limpiar imÃ¡genes mostradas
    --help              Mostrar esta ayuda

FORMATOS SOPORTADOS:
    ImÃ¡genes: jpg, jpeg, png, gif, bmp, webp, tiff, ico, svg
    Animados: gif, apng, webp (animaciÃ³n se reproduce)
    Otros: pdf (primera pÃ¡gina), eps, ai

EJEMPLOS:
    tr image /home/daniel/Imagenes/foto.jpg
        Mostrar imagen individual

    tr image --grid *.png
        Mostrar todas las PNG en cuadrÃ­cula

    tr image --width 80 --align center logo.png
        Mostrar imagen centrada con 80 columnas de ancho

    tr image --scale-up icono_small.png
        Escalar imagen pequeÃ±a para mejor visibilidad

    tr image --clear
        Limpiar todas las imÃ¡genes mostradas

ATAJOS DE TECLADO (durante visualizaciÃ³n):
    q            Salir
    ESPACIO      Siguiente imagen (en modo grid)
    â†/â†’          Navegar entre imÃ¡genes
    +/-          Acercar/Alejar
    r            Rotar imagen
    f            Toggle fullscreen (si estÃ¡ disponible)

INTEGRACIONES RECOMENDADAS:
    - ranger:     Ver previsualizaciones en file manager
    - viu:        Alternativa a icat (viu imagen.png)
    - term-image: Visor con mÃ¡s opciones (term-image show img.png)

NOTAS:
    - Este comando estÃ¡ diseÃ±ado para kitty terminal
    - Usa el protocolo de grÃ¡ficos kitty (icat kitten)
    - Las imÃ¡genes se muestran inline en el terminal
    - Funciona sobre SSH con kitty

ALTERNATIVAS:
    # Usar icat directamente
    kitten icat imagen.jpg

    # Usar viu (otro visor)
    viu imagen.jpg

    # Usar term-image
    term-image show imagen.jpg

VERSIÃ“N: 1.0.0
EOF
}

# FunciÃ³n para verificar si estamos en kitty
check_kitty() {
    if [ -z "$KITTY_WINDOW_ID" ] && [ -z "$KITTY_LISTEN_ON" ]; then
        echo -e "${YELLOW}âš  Advertencia: No estÃ¡s en kitty terminal${NC}"
        echo -e "${YELLOW}  tr-image requiere kitty para mostrar imÃ¡genes${NC}"
        echo -e "${YELLOW}  Intentando de todos modos...${NC}"
        echo ""
    fi
}

# FunciÃ³n para mostrar imagen individual
show_image() {
    local image_file="$1"
    local width="$2"
    local height="$3"
    local align="$4"
    local scale_up="$5"
    
    if [ ! -f "$image_file" ]; then
        echo -e "${RED}âœ— Error: Archivo no encontrado: $image_file${NC}"
        return 1
    fi
    
    # Construir argumentos para icat
    local icat_args=()
    [ -n "$width" ] && icat_args+=("--width=$width")
    [ -n "$height" ] && icat_args+=("--height=$height")
    [ -n "$align" ] && icat_args+=("--align=$align")
    [ -n "$scale_up" ] && icat_args+=("--scale-up")
    
    # Mostrar imagen con icat
    kitten icat "${icat_args[@]}" "$image_file"
}

# FunciÃ³n para mostrar imÃ¡genes en grid
show_grid() {
    local images=("$@")
    
    if [ ${#images[@]} -eq 0 ]; then
        echo -e "${RED}âœ— Error: No se proporcionaron imÃ¡genes${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}ğŸ–¼ï¸  tr-image: Mostrando ${#images[@]} imagen(es) en cuadrÃ­cula${NC}"
    echo ""
    
    # Usar icat con mÃºltiples archivos
    kitten icat --grid "${images[@]}"
}

# FunciÃ³n para limpiar imÃ¡genes
clear_images() {
    # Enviar secuencia de escape para limpiar grÃ¡ficos
    printf "\033[3J"
    echo -e "${GREEN}âœ“ ImÃ¡genes limpiadas${NC}"
}

# Parsear argumentos
GRID_MODE=false
WIDTH=""
HEIGHT=""
ALIGN=""
SCALE_UP=""
CLEAR_MODE=false
IMAGE_FILES=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_help
            exit 0
            ;;
        --grid|-g)
            GRID_MODE=true
            shift
            ;;
        --width|-w)
            WIDTH="$2"
            shift 2
            ;;
        --height)
            HEIGHT="$2"
            shift 2
            ;;
        --align)
            ALIGN="$2"
            shift 2
            ;;
        --scale-up)
            SCALE_UP="--scale-up"
            shift
            ;;
        --clear)
            CLEAR_MODE=true
            shift
            ;;
        -*)
            echo -e "${RED}âœ— OpciÃ³n desconocida: $1${NC}"
            echo "Usa 'tr image --help' para mÃ¡s informaciÃ³n"
            exit 1
            ;;
        *)
            IMAGE_FILES+=("$1")
            shift
            ;;
    esac
done

# Modo limpiar
if [ "$CLEAR_MODE" = true ]; then
    clear_images
    exit 0
fi

# Verificar que se proporcionaron archivos
if [ ${#IMAGE_FILES[@]} -eq 0 ]; then
    echo -e "${RED}âœ— Error: Se requiere al menos un archivo de imagen${NC}"
    echo "Usa 'tr image --help' para mÃ¡s informaciÃ³n"
    exit 1
fi

# Verificar kitten (icat)
if ! command -v kitten &> /dev/null; then
    echo -e "${RED}âœ— Error: kitten no estÃ¡ disponible${NC}"
    echo "AsegÃºrate de que kitty estÃ¡ instalado correctamente"
    exit 1
fi

# Verificar kitty
check_kitty

# Ejecutar segÃºn modo
if [ "$GRID_MODE" = true ]; then
    show_grid "${IMAGE_FILES[@]}"
else
    # Mostrar imÃ¡genes individuales
    for image in "${IMAGE_FILES[@]}"; do
        echo -e "${CYAN}ğŸ–¼ï¸  Mostrando:${NC} $image"
        show_image "$image" "$WIDTH" "$HEIGHT" "$ALIGN" "$SCALE_UP"
        echo ""
    done
fi
