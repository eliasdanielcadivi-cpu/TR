#!/bin/bash
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# tr-video - Reproductor de video para kitty terminal
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# ReproducciÃ³n de video en kitty usando mpv con protocolo de grÃ¡ficos de kitty.
# Solo funciona en kitty terminal (usa el protocolo de grÃ¡ficos kitty).
#
# USO:
#   tr video /ruta/al/video.mp4
#   tr video --sub /ruta/al/sub.srt /ruta/al/video.mp4
#   tr video --start 00:01:30 video.mp4
#   tr video --loop video.mp4
#   tr video --speed 1.5 video.mp4
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ConfiguraciÃ³n
TR_BASE="/home/daniel/tron/programas/TR"
MPV_CONF="$TR_BASE/config/mpv/mpv.conf"

# FunciÃ³n para mostrar ayuda
show_help() {
    cat << 'EOF'
tr-video - Reproductor de video para kitty terminal
====================================================

USO:
    tr video [OPCIONES] <archivo_de_video>

OPCIONES:
    --sub <archivo>     Cargar archivo de subtÃ­tulos (.srt, .ass, .sub)
    --start <tiempo>    Iniciar reproducciÃ³n en timestamp (ej: 00:01:30 o 90)
    --loop              Reproducir en bucle infinito
    --speed <valor>     Velocidad de reproducciÃ³n (0.5-2.0, default: 1.0)
    --volume <valor>    Volumen (0-100, default: 80)
    --audio-only        Solo audio (no mostrar video)
    --screenshot        Tomar captura de pantalla al finalizar
    --help, -h          Mostrar esta ayuda

EJEMPLOS:
    tr video /home/daniel/Videos/pelicula.mp4
        Reproducir video normalmente

    tr video --sub /home/daniel/Videos/pelicula.srt pelicula.mp4
        Reproducir video con subtÃ­tulos

    tr video --start 00:05:00 video.mp4
        Iniciar video en el minuto 5

    tr video --loop --speed 1.25 anime.mp4
        Reproducir anime en bucle a 1.25x

    tr video --audio-only podcast.mp4
        Reproducir solo audio (Ãºtil para podcasts)

ATAJOS DE TECLADO DURANTE REPRODUCCIÃ“N:
    ESPACIO      Pausar/Reproducir
    q            Salir
    f            Pantalla completa
    â†/â†’          Adelante/AtrÃ¡s 5 segundos
    â†‘/â†“          Adelante/AtrÃ¡s 1 minuto
    9/0          Bajar/Subir volumen
    j            Cambiar pista de subtÃ­tulos
    v            Cambiar pista de video
    s            Tomar captura de pantalla

FORMATOS SOPORTADOS:
    Video: mp4, mkv, avi, webm, mov, flv, wmv
    Audio: mp3, flac, ogg, m4a, wav, aac
    SubtÃ­tulos: srt, ass, sub, idx

NOTAS:
    - Este comando estÃ¡ diseÃ±ado para funcionar en kitty terminal
    - Usa el protocolo de grÃ¡ficos de kitty para renderizado
    - La configuraciÃ³n estÃ¡ en: TR/config/mpv/mpv.conf
    - Para mejor rendimiento: videos <1080p recomendados

CONFIGURACIÃ“N:
    Editar: /home/daniel/tron/programas/TR/config/mpv/mpv.conf

VERSIÃ“N: 1.0.0
EOF
}

# FunciÃ³n para verificar si estamos en kitty
check_kitty() {
    if [ -z "$KITTY_WINDOW_ID" ] && [ -z "$KITTY_LISTEN_ON" ]; then
        echo -e "${YELLOW}âš  Advertencia: No estÃ¡s en kitty terminal${NC}"
        echo -e "${YELLOW}  tr-video funciona mejor en kitty (usa protocolo de grÃ¡ficos)${NC}"
        echo -e "${YELLOW}  Continuando de todos modos...${NC}"
        echo ""
    fi
}

# FunciÃ³n para reproducir video
play_video() {
    local video_file="$1"
    shift
    local extra_args=("$@")
    
    if [ ! -f "$video_file" ]; then
        echo -e "${RED}âœ— Error: Archivo no encontrado: $video_file${NC}"
        exit 1
    fi
    
    echo -e "${CYAN}ğŸ¬ tr-video: Reproduciendo${NC}"
    echo -e "   Archivo: $video_file"
    echo ""
    
    # Construir comando mpv
    local mpv_cmd=(
        mpv
        --config="$MPV_CONF"
        --profile=sw-fast
        --vo=kitty
        --vo-kitty-use-shm=yes
        --really-quiet
        "${extra_args[@]}"
        "$video_file"
    )
    
    # Ejecutar mpv
    "${mpv_cmd[@]}"
}

# Parsear argumentos
SUB_FILE=""
START_TIME=""
LOOP_FLAG=""
SPEED=""
VOLUME=""
AUDIO_ONLY=""
SCREENSHOT_FLAG=""
VIDEO_FILE=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --help|-h)
            show_help
            exit 0
            ;;
        --sub)
            SUB_FILE="$2"
            shift 2
            ;;
        --start)
            START_TIME="$2"
            shift 2
            ;;
        --loop)
            LOOP_FLAG="--loop-file=inf"
            shift
            ;;
        --speed)
            SPEED="--speed=$2"
            shift 2
            ;;
        --volume)
            VOLUME="--volume=$2"
            shift 2
            ;;
        --audio-only)
            AUDIO_ONLY="--vid=no"
            shift
            ;;
        --screenshot)
            SCREENSHOT_FLAG="--screenshot-format=png"
            shift
            ;;
        -*)
            echo -e "${RED}âœ— OpciÃ³n desconocida: $1${NC}"
            echo "Usa 'tr video --help' para mÃ¡s informaciÃ³n"
            exit 1
            ;;
        *)
            VIDEO_FILE="$1"
            shift
            ;;
    esac
done

# Verificar que se proporcionÃ³ un archivo de video
if [ -z "$VIDEO_FILE" ]; then
    echo -e "${RED}âœ— Error: Se requiere un archivo de video${NC}"
    echo "Usa 'tr video --help' para mÃ¡s informaciÃ³n"
    exit 1
fi

# Verificar mpv
if ! command -v mpv &> /dev/null; then
    echo -e "${RED}âœ— Error: mpv no estÃ¡ instalado${NC}"
    echo "Instala mpv: sudo apt install mpv"
    exit 1
fi

# Verificar kitty
check_kitty

# Construir argumentos extra
EXTRA_ARGS=()
[ -n "$SUB_FILE" ] && EXTRA_ARGS+=("--sub-file=$SUB_FILE")
[ -n "$START_TIME" ] && EXTRA_ARGS+=("--start=$START_TIME")
[ -n "$LOOP_FLAG" ] && EXTRA_ARGS+=("$LOOP_FLAG")
[ -n "$SPEED" ] && EXTRA_ARGS+=("$SPEED")
[ -n "$VOLUME" ] && EXTRA_ARGS+=("$VOLUME")
[ -n "$AUDIO_ONLY" ] && EXTRA_ARGS+=("$AUDIO_ONLY")
[ -n "$SCREENSHOT_FLAG" ] && EXTRA_ARGS+=("$SCREENSHOT_FLAG")

# Reproducir video
play_video "$VIDEO_FILE" "${EXTRA_ARGS[@]}"
