#!/bin/bash
# tr-color - M√≥dulo de coloreado de pesta√±as Kitty
# ==================================================
# CLI independiente para gesti√≥n de colores de pesta√±as
# basado en rutas de archivos o patrones.
#
# USO:
#   tr-color <ruta>              # Aplica color seg√∫n ruta
#   tr-color --auto              # Detecta archivo reciente en PWD
#   tr-color --list              # Lista reglas configuradas
#   tr-color --test <ruta>       # Muestra regla sin aplicar
#   tr-color --help              # Muestra esta ayuda
#
# EJEMPLOS:
#   tr-color /home/daniel/Escritorio/QT5/elAsunto.md
#   tr-color --auto
#   tr-color --list
#
# NOTA: Requiere kitty corriendo con socket en /tmp/mykitty

set -e

# Directorio base de TR
TR_BASE="/home/daniel/tron/programas/TR"
cd "$TR_BASE"

# Funci√≥n para mostrar ayuda
show_help() {
    cat << 'EOF'
tr-color - Coloreado autom√°tico de pesta√±as Kitty
===================================================

USO:
    tr-color [OPCIONES] [RUTA]

OPCIONES:
    --auto          Detecta archivo m√°s reciente en directorio actual
                    y aplica color seg√∫n su ruta

    --list          Lista todas las reglas configuradas con sus
                    colores y t√≠tulos

    --test <ruta>   Muestra qu√© regla se aplicar√≠a sin ejecutarla
                    (√∫til para depuraci√≥n)

    --title <ruta>  Solo muestra el t√≠tulo que se aplicar√≠a

    --color <ruta>  Solo muestra el color que se aplicar√≠a

    --help, -h      Muestra esta ayuda

ARGUMENTOS:
    RUTA            Ruta del archivo para determinar el color
                    (obligatorio si no se usa --auto, --list, --test)

EJEMPLOS:
    tr-color /home/daniel/Escritorio/QT5/elAsunto.md
        Aplica color naranja (#ff6600) y t√≠tulo "EL ASUNTO"

    tr-color --auto
        Detecta archivo reciente en PWD y colorea pesta√±a

    tr-color --test archivo.md
        Muestra qu√© regla coincidir√≠a sin aplicar cambios

    tr-color --list
        Muestra todas las reglas configuradas

INTEGRACI√ìN CON TR:
    Este comando puede ser llamado desde la IA de TR:
    tr p "colorea la pesta√±a con el archivo elAsunto.md"

    O directamente desde shell:
    tr-color /ruta/al/archivo

NOTAS:
    - Requiere kitty corriendo con socket en /tmp/mykitty
    - El color persiste mientras la pesta√±a est√© abierta
    - SelectorHacker maneja colores del sistema (qt5ct), no kitty

VERSI√ìN: 1.0.0
EOF
}

# Funci√≥n para listar reglas
list_rules() {
    uv run --quiet python -c "
from modules.color import ColorEngine
engine = ColorEngine('modules/color/config.yaml')
rules = engine.list_rules()
print('REGLAS CONFIGURADAS:')
print('=' * 60)
for i, rule in enumerate(rules, 1):
    print(f\"{i:2}. {rule['pattern']}\")
    print(f\"    Color: {rule['color']}  |  T√≠tulo: {rule['title']}  |  Prioridad: {rule['priority']}\")
print('=' * 60)
print(f'Total: {len(rules)} reglas')
"
}

# Funci√≥n para testear regla (sin aplicar)
test_rule() {
    local path="$1"
    uv run --quiet python -c "
from modules.color import ColorEngine
engine = ColorEngine('modules/color/config.yaml')
rule = engine.get_rule_for_path('$path')
print('RESULTADO DEL TEST:')
print('=' * 60)
print(f\"Ruta:    $path\")
print(f\"Color:   {rule['color']}\")
print(f\"T√≠tulo:  {rule['title']}\")
print(f\"Patr√≥n:  {rule['pattern']}\")
print(f\"Prioridad: {rule['priority']}\")
print('=' * 60)
"
}

# Funci√≥n para obtener solo t√≠tulo
get_title() {
    local path="$1"
    uv run --quiet python -c "
from modules.color import ColorEngine
engine = ColorEngine('modules/color/config.yaml')
print(engine.get_title_for_path('$path'))
"
}

# Funci√≥n para obtener solo color
get_color() {
    local path="$1"
    uv run --quiet python -c "
from modules.color import ColorEngine
engine = ColorEngine('modules/color/config.yaml')
print(engine.get_color_for_path('$path'))
"
}

# Funci√≥n para aplicar color
apply_color() {
    local path="$1"
    uv run --quiet python -c "
import sys
from modules.color import ColorEngine

engine = ColorEngine('modules/color/config.yaml')
success = engine.apply('$path')

if success:
    rule = engine.get_rule_for_path('$path')
    print(f\"‚úì Color aplicado: {rule['color']} | T√≠tulo: {rule['title']}\")
    sys.exit(0)
else:
    print('‚úó Error: No se pudo aplicar el color')
    print('  Posibles causas:')
    print('  - Kitty no est√° corriendo')
    print('  - Socket /tmp/mykitty no existe')
    print('  - Permiso denegado')
    sys.exit(1)
"
}

# Funci√≥n para auto-detectar archivo reciente
auto_detect() {
    # Obtener archivo m√°s reciente en PWD
    local file=$(ls -t 2>/dev/null | head -1)
    
    if [ -z "$file" ]; then
        echo "‚úó No se encontraron archivos en el directorio actual"
        exit 1
    fi
    
    local fullpath="$PWD/$file"
    echo "üìÅ Archivo detectado: $file"
    echo "üìç Ruta completa: $fullpath"
    echo ""
    apply_color "$fullpath"
}

# Parsear argumentos
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --list)
        list_rules
        ;;
    --test)
        if [ -n "${2:-}" ]; then
            test_rule "$2"
        else
            echo "‚úó Error: --test requiere una ruta"
            echo "Uso: tr-color --test <ruta>"
            exit 1
        fi
        ;;
    --title)
        if [ -n "${2:-}" ]; then
            get_title "$2"
        else
            echo "‚úó Error: --title requiere una ruta"
            exit 1
        fi
        ;;
    --color)
        if [ -n "${2:-}" ]; then
            get_color "$2"
        else
            echo "‚úó Error: --color requiere una ruta"
            exit 1
        fi
        ;;
    --auto)
        auto_detect
        ;;
    "")
        echo "‚úó Error: Se requiere una ruta o opci√≥n"
        echo ""
        show_help
        exit 1
        ;;
    *)
        # Asumir que es una ruta
        if [ -e "$1" ] || [[ "$1" == /* ]]; then
            apply_color "$1"
        else
            echo "‚úó Error: Ruta no v√°lida: $1"
            exit 1
        fi
        ;;
esac
